name: CI/CD Pipeline - Proyecto Final

on:
  push:
    branches: [ "main" ]

jobs:
  # JOB 1: Construcción y Push a Docker Hub
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Código
        uses: actions/checkout@v3

      - name: Login en Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-backend-api:latest

      - name: Build and Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-frontend-spa:latest

  # JOB 2: Despliegue en EC2 vía SSH
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout Código (para obtener configs de monitoreo)
        uses: actions/checkout@v3

      - name: Desplegar en EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Navegar al directorio del proyecto
            cd ~/CertiDevOps-Parcial3YoshuaToro70714 || git clone https://github.com/${{ github.repository }}.git
            cd ~/CertiDevOps-Parcial3YoshuaToro70714
            
            # 2. Actualizar archivos de configuración (Prometheus, Loki, etc.)
            git pull origin main
            
            # 3. Autenticar Docker para el Pull
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
            
            # 4. Desplegar Stack Completo (App + Monitoreo)
            sudo docker-compose down
            sudo docker-compose pull
            sudo docker-compose up -d
            
            # 5. Limpieza de imágenes huérfanas
            sudo docker image prune -f

  # JOB 3: Notificación a Discord
  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always() # Se ejecuta aunque falle el despliegue para avisar el estado
    steps:
      - name: Enviar Notificación a Discord
        uses: rjs-team/discord-webhooks-notify@v1
        with:
          severity: ${{ needs.deploy.result == 'success' && 'info' || 'error' }}
          details: |
            **Estado del Despliegue:** ${{ needs.deploy.result == 'success' && '✅ EXITOSO' || '❌ FALLIDO' }}
            **Proyecto:** ${{ github.repository }}
            **Autor:** ${{ github.actor }}
            **Commit:** ${{ github.sha }}
            **URL App:** http://${{ secrets.EC2_HOST }}
            **URL Grafana:** http://${{ secrets.EC2_HOST }}:3000
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_URL }}
